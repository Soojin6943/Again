<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title> 지도에서 찾기 </title>
    <style>
        #map-container {
            display: flex;
        }
        #map {
            width: 80%;
            height: 800px;
        }
        #content-list {
            width: 20%;
            margin-top: 20px;
            padding: 10px;
            overflow-y: auto;
            background-color: #f9f9f9;
            border-right: 1px solid #ddd;
        }
        #content-list h2 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }
        #content-titles {
            list-style: none;
            padding: 0;
        }
        #content-titles li {
            margin: 5px 0;
        }
        #content-titles a {
            text-decoration: none;
            color: #007bff;
        }
        #content-titles a:hover {
            text-decoration: underline;
        }
        .pagination {
            margin-top: 10px;
            display: flex;
            justify-content: center;
        }
        .pagination button {
            margin: 0 5px;
            padding: 5px 10px;
        }
    </style>
</head>
<body>
    <div id="map-container">
        <div id="content-list">
            <div>{{ user.username }}(ID: {{ user.id }})</div>
            <a href="{% url 'index' %}">홈으로</a>
            {% if not request.user.is_authenticated %}
                <a href="{% url 'login'%}">로그인</a>
                <a href="{% url 'signup'%}">회원가입</a>
            {% endif %}
            {% if request.user.is_authenticated %}
                <a href="{% url 'my_page'%}">마이페이지</a>
                <a href="{% url 'logout'%}">로그아웃</a>
            {% endif %}
            <h2>콘텐츠 목록</h2>
            <ul id="content-titles"></ul>
            <div class="pagination">
                <button id="prev-btn" disabled>이전</button>
                <button id="next-btn">다음</button>
            </div>
        </div>
        <div id="map"></div>
    </div>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=77ce1142d1174a7bb72f1d47e3db5670&libraries=services"></script>
    <script>
        var container = document.getElementById('map');  // 지도를 표시할 div
        var options = {
            center: new kakao.maps.LatLng(33.450701, 126.570667),  // 지도의 중심 좌표 (위도, 경도)
            level: 6  // 지도 확대 레벨
        };

        // 지도 생성
        var map = new kakao.maps.Map(container, options);   // 지도 생성
        var zoomControl = new kakao.maps.ZoomControl();
        map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);
        map.setMaxLevel(12);
        var geocoder = new kakao.maps.services.Geocoder();
        var positions = [];

        // 데이터들 넣기
        {% for mapL in mapList %}
            positions.push({
                id: '{{ mapL.id }}',
                title: '{{ mapL.title }}',
                address: '{{ mapL.location }}',
                content: '{{ mapL.content }}',
                organization: '{{ mapL.organization_name }}',
                people: '{{ mapL.type_of_people }}',
                home: '{{ mapL.content_link }}',
                url: '{% url "content" mapL.id %}',
            });
        {% endfor %}

        var currentPage = 1;
        var itemsPerPage = 15;
        var filteredPositions = positions;  // Default to all positions

        function displayPage(page) {
            var contentList = document.getElementById('content-titles');
            contentList.innerHTML = '';  // 기존 목록 초기화
            var index = (page - 1) * itemsPerPage + 1;  // 번호 초기화
            var start = (page - 1) * itemsPerPage;
            var end = start + itemsPerPage;
            var currentPositions = filteredPositions.slice(start, end);

            currentPositions.forEach(function (pos, i) {
                var li = document.createElement('li');
                var a = document.createElement('a');
                a.href = pos.url;
                a.textContent = (start + i + 1) + '. ' + pos.title;
                li.appendChild(a);
                contentList.appendChild(li);
            });

            // 페이지 버튼 상태 업데이트
            document.getElementById('prev-btn').disabled = page === 1;
            document.getElementById('next-btn').disabled = end >= filteredPositions.length;
        }

        document.getElementById('prev-btn').addEventListener('click', function() {
            if (currentPage > 1) {
                currentPage--;
                displayPage(currentPage);
            }
        });

        document.getElementById('next-btn').addEventListener('click', function() {
            if ((currentPage * itemsPerPage) < filteredPositions.length) {
                currentPage++;
                displayPage(currentPage);
            }
        });

        positions.forEach(function (position) {
            geocoder.addressSearch(position.address, function(result, status) {
                if (status === kakao.maps.services.Status.OK) {
                    var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                    var marker = new kakao.maps.Marker({
                        map: map,
                        position: coords,
                        clickable: true
                    });

                    var iwContent = '<div style="width:150px; text-align:center; padding:6px 0;">' + position.organization + '</div>',
                        iwRemoveable = true;
                    var infowindow = new kakao.maps.InfoWindow({
                        content: iwContent,
                        removable: iwRemoveable
                    });

                    kakao.maps.event.addListener(marker, 'click', function() {
                        infowindow.open(map, marker);
                        map.setCenter(coords);

                        // 콘텐츠 목록 업데이트
                        currentPage = 1;  // 페이지 초기화
                        filteredPositions = positions.filter(function (pos) {
                            return pos.organization === position.organization;
                        });
                        displayPage(currentPage);
                    });

                    kakao.maps.event.addListener(map, 'click', function () {
                        infowindow.close();
                    });
                }
            });
        });

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                var lat = position.coords.latitude,
                    lon = position.coords.longitude;
                var locPosition = new kakao.maps.LatLng(lat, lon);
                map.setCenter(locPosition);
            });
        } else {
            var locPosition = new kakao.maps.LatLng(33.450701, 126.570667);
            map.setCenter(locPosition);
        }

        // 초기 페이지 로드
        displayPage(currentPage);
    </script>
</body>
</html>
