<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title> 지도에서 찾기 </title>
    
    {% comment %} 지도 css {% endcomment %}
    <style>
        .wrap {
            position: absolute;
            left: 0;
            bottom: 40px;
            width: 288px;
            height: 132px;
            margin-left: -144px;
            text-align: left;
            overflow: hidden;
            font-size: 12px;
            font-family: 'Malgun Gothic', dotum, '돋움', sans-serif;
            line-height: 1.5; 
        }
        .wrap * {
            padding: 0;
            margin: 0;
        }
        .wrap .info {
            width: 286px;
            height 120px;
            border-radius: 5px;
            border-bottom: 2px solid #ccc;
            border-right: 1px solid #ccc;
            overflow: hidden;
            background: #fff;
        }
        .wrap .info:nth-child(1) {
            border: 0;
            box-shadaw: 0px 1px 2px #888;
        }
        .info .title {
            padding: 5px 0 0 10px;
            height: 30px;
            background: #eee;
            border-bottom: 1px solid #ddd;
            font-size: 18px;
            font-weight: bold;
        }
        .info .close {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #888;
            width: 17px; 
            height: 17px;
            background: url('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/overlay_close.png');
        }
        .info .close:hover {
            cursor: pointer;
        }
        .info .body {
            position: relative;
            overflow: hidden;
        }
        .info .desc {
            position: relative;
            margin: 5px 10px 0px 10px;
            height: 75px;
        }
        .desc .ellipsis {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .info:after {
            content: '';
            position: absolute;
            margin-left: -12px;
            left: 50%;
            bottom: 0;
            width: 22px;
            height: 12px;
            background: url('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/vertex_white.png')
        }
        .info .link{
            color: #5085BB;
        }


    </style>
    
    {% comment %} 이건 사이드바 {% endcomment %}
    <style>
    /* GOOGLE FONTS */
    @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap");

    /* VARIABLES CSS */
    :root {
        --nav--width: 92px;

        /* Colores */
        --first-color: #0c5df4;
        --bg-color: #12192c;
        --sub-color: #b6cefc;
        --white-color: #fff;

        /* Fuente y tipografia */
        --body-font: 'Poppins', sans-serif;
        --normal-font-size: 1rem;
        --small-font-size: .875rem;

        /* z index */
        --z-fixed: 100;
    }

    /* BASE */
    *, ::before, ::after {
        box-sizing: border-box;
    }

    body {
        position: relative;
        margin: 0;
        padding: 0;
        font-family: var(--body-font);
        font-size: var(--normal-font-size);
        transition: .5s;
    }

    h1 {
        margin: 0;
    }

    ul {
        margin: 0;
        padding: 0;
        list-style: none;
    }

    a {
        text-decoration: none;
    }

    /* l NAV */
    .l-navbar {
        position: fixed;
        top: 0;
        left: 0;
        width: var(--nav--width);
        height: 100vh;
        background-color: var(--bg-color);
        color: var(--white-color);
        padding: 1.5rem 1.5rem 2rem;
        transition: .5s;
        z-index: var(--z-fixed);
    }

    .search {
        margin-left: 500px;
    }

    /* NAV */
    .nav {
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        overflow: hidden;
    }

    .nav__brand {
        display: grid;
        grid-template-columns: max-content max-content;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .nav__toggle {
        font-size: 1.25rem;
        padding: .75rem;
        cursor: pointer;
    }

    .nav__logo {
        color: var(--white-color);
        font-weight: 600;
    }

    .nav__link {
        display: grid;
        grid-template-columns: max-content max-content;
        align-items: center;
        column-gap: .75rem;
        padding: .75rem;
        color: var(--white-color);
        border-radius: .5rem;
        margin-bottom: 1rem;
        transition: .3s;
        cursor: pointer;
    }

    .nav__link:hover {
        background-color: var(--first-color);
    }

    .nav__icon {
        font-size: 1.25rem;
    }

    .nav_name {
        font-size: var(--small-font-size);
    }

    /* Expander menu */
    .expander {
        width: calc(var(--nav--width) + 9.25rem);
    }

    /* Add padding body*/
    .body-pd {
        padding: 2rem 0 0 16rem;
    }

    /* Active links menu */
    .active {
        background-color: var(--first-color);
    }

    /* COLLAPSE */
    .collapse {
        grid-template-columns: 20px max-content 1fr;
    }

    .collapse__link {
        justify-self: flex-end;
        transition: .5;
    }

    .collapse__menu {
        display: none;
        padding: .75rem 2.25rem;
    }

    .collapse__sublink {
        color: var(--sub-color);
        font-size: var(--small-font-size);
    }

    .collapse__sublink:hover {
        color: var(--white-color);
    }

    /* Show collapse */
    .showCollapse {
        display: block;
    }

    /* Rotate icon */
    .rotate {
        transform: rotate(180deg);
        transition: .5s;
    }
    </style>
</head>
<body>
    <div id="map" style="width:100%; height:800px;"></div>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=77ce1142d1174a7bb72f1d47e3db5670&libraries=services"></script>
    <script>
        var container = document.getElementById('map');  //지도를 표시 할 div

        var options = {
            center: new kakao.maps.LatLng(33.450701, 126.570667),  // 지도의 중심 좌표
            level: 6  // 지도 확대 레벨
        };

        // 지도 생성
        var map = new kakao.maps.Map(container, options);   // 지도 생성

        // 지도 확대 축소를 제어할 수 있는  줌 컨트롤을 생성
        var zoomControl = new kakao.maps.ZoomControl();
        map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);

        // 최대 확대 레벨 설정
        map.setMaxLevel(10);

        // 위치 검색을 위한 개체 생성
        var geocoder = new kakao.maps.services.Geocoder();

        // 마커 표시할 위치들
        var positions = new Array();

        // 데이터들 넣기
        {% for mapL in mapList %}
            positions.push({
                title: '{{ mapL.title }}',
                address: '{{ mapL.location }}',
                content: '{{ mapL.content }}',
                organization : '{{ mapL.organization_name}}',
                people: '{{ mapL.type_of_people}}',
                home: '{{ mapL.content_link }}'
            })
        {% endfor %}

        // 마커랑 인포윈도우 생성
        positions.forEach(function (position) {
            geocoder.addressSearch(position.address, function(result, status) {

                // 위치 검색 가능할 경우
                if(status === kakao.maps.services.Status.OK) {
                    var coords = new kakao.maps.LatLng(result[0].y, result[0].x);

                    // 마커 생성
                    var marker = new kakao.maps.Marker({
                        map: map, // 마커 표시할 지도
                        position: coords,  // 마커 표시할 위치
                        clickable: true
                    });

                    // 커스텀 오버레이
                    var content = '<div class="wrap">' +
                                    '<div class="info">' +
                                        '<div class="title">' + 
                                            position.title +
                                            '<div class="close" onclick="closeOverlay()" title="닫기"></div>' +
                                        '</div>' +
                                        '<div class="body">' +
                                            '<div class="desc">' +
                                                '<div class="ellipsis">' + 
                                                    position.content + '</br>' +
                                                    "운영기관 : " + position.organization + '</br>' +
                                                    "대상 : " + position.people + '</br>' +
                                                    {% comment %} "교육 장소 : " + position.address + '</br>' + {% endcomment %}
                                                    '<a href="'+position.home+'">' + "홈페이지 이동하기" + '</a>'
                                                '</div>' +
                                            '</div>' +
                                        '</div>' +
                                    '</div>' +
                                '</div>';

                    var overlay = new kakao.maps.CustomOverlay({
                        content : content,
                        map : map,
                        position : marker.getPosition()
                    });

                    overlay.setMap(null);
                    
                    kakao.maps.event.addListener(marker, 'click', function() {
                        overlay.setMap(map);
                        map.setCenter(coords);
                    });

                    {% comment %} function closeOverlay() {
                        overlay.setMap(null);     
                    } {% endcomment %}

                    kakao.maps.event.addListener(map, 'click', function () {
                        overlay.setMap(null);
                    });
                }
            });
        });

        if (navigator.geolocation) { // HTML5로 geolocation 사용 여부 확인

            // GeoLocation 이용해서 접속 위치 얻기
            navigator.geolocation.getCurrentPosition(function(position) {
                var lat = position.coords.latitude, // 위도
                lon = position.coords.longitude; // 경도

                var locPosition = new kakao.maps.LatLng(lat, lon);

                map.setCenter(locPosition);
            });
        } else { // 사용할 수 없을 경우
            var locPosition = new kakao.maps.LatLng(33.450701, 126.570667);

            map.setCenter(locPosition);
        }
    </script>

    <form method="GET" class='search'>
        <input type="text" name='q' {% if search_query %} value="{{ search_query }}"{% endif %}>
        <button type="submit">검색</button>
    </form>

    {% comment %} 이거슨 사이드바 {% endcomment %}

    <div class="l-navbar" id="navbar">
        <nav class="nav">
            <div>
                <div class="nav__brand">
                    <ion-icon name="menu-outline" class="nav__toggle" id="nav-toggle"></ion-icon>
                    <a href="#" class="nav__logo">Again</a>
                </div>
                <div class="nav__list">
                    <a href="{% url 'index' %}" class="nav__link active">
                        <ion-icon name="home-outline" class="nav__icon"></ion-icon>
                        <span class="nav_name">HOME</span>
                    </a>
                    
                    <a href="#" class="nav__link">
                        <ion-icon name="chatbubbles-outline" class="nav__icon"></ion-icon>
                        <span class="nav_name">Messenger</span>
                    </a>

                    <div href="#" class="nav__link collapse">
                        <ion-icon name="folder-outline" class="nav__icon"></ion-icon>
                        <span class="nav_name">Projects</span>

                        <ion-icon name="chevron-down-outline" class="collapse__link"></ion-icon>

                        <ul class="collapse__menu">
                            <a href="#" class="collapse__sublink">Data</a>
                            <a href="#" class="collapse__sublink">Group</a>
                            <a href="#" class="collapse__sublink">Members</a>
                        </ul>
                    </div>

                    <a href="#" class="nav__link">
                        <ion-icon name="pie-chart-outline" class="nav__icon"></ion-icon>
                        <span class="nav_name">Analytics</span>
                    </a>

                    <div href="#" class="nav__link collapse">
                        <ion-icon name="people-outline" class="nav__icon"></ion-icon>
                        <span class="nav_name">Team</span>

                        <ion-icon name="chevron-down-outline" class="collapse__link"></ion-icon>

                        <ul class="collapse__menu">
                            <a href="#" class="collapse__sublink">Data</a>
                            <a href="#" class="collapse__sublink">Group</a>
                            <a href="#" class="collapse__sublink">Members</a>
                        </ul>
                    </div>

                    <a href="#" class="nav__link">
                        <ion-icon name="settings-outline" class="nav__icon"></ion-icon>
                        <span class="nav_name">HOME</span>
                    </a>
                </div>
                <a href="#" class="nav__link">
                    <ion-icon name="log-out-outline" class="nav__icon"></ion-icon>
                    <span class="nav_name">Log out</span>
                </a>
            </div>
        </nav>
    </div>

    <!-- IONICONS -->
    <script src="https://unpkg.com/ionicons@5.2.3/dist/ionicons.js"></script>
    <!-- JS -->
    <script>
        /* EXPANDER MENU */
        const showMenu = (toggleId, navbarId, bodyId) => {
            const toggle = document.getElementById(toggleId),
            navbar = document.getElementById(navbarId),
            bodypadding = document.getElementById(bodyId)

            if( toggle && navbar ) {
                toggle.addEventListener('click', ()=>{
                    navbar.classList.toggle('expander');

                    bodypadding.classList.toggle('body-pd')
                })
            }
        }

        showMenu('nav-toggle', 'navbar', 'body-pd')

        /* LINK ACTIVE */
        const linkColor = document.querySelectorAll('.nav__link')
        function colorLink() {
            linkColor.forEach(l=> l.classList.remove('active'))
            this.classList.add('active')
        }
        linkColor.forEach(l=> l.addEventListener('click', colorLink))

        /* COLLAPSE MENU */
        const linkCollapse = document.getElementsByClassName('collapse__link')
        var i

        for(i=0;i<linkCollapse.length;i++) {
            linkCollapse[i].addEventListener('click', function(){
                const collapseMenu = this.nextElementSibling
                collapseMenu.classList.toggle('showCollapse')

                const rotate = collapseMenu.previousElementSibling
                rotate.classList.toggle('rotate')
            });
        }

    </script>
</body>
</html>
